{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "ArgusOmni Test Suite",
    "description": "Validation schema for ArgusOmni test definition files (.argus.yml)",
    "type": "object",
    "properties": {
        "env": {
            "type": "object",
            "description": "Global environment variables",
            "additionalProperties": {
                "type": "string"
            }
        },
        "variables": {
            "type": "object",
            "description": "Test suite variables",
            "additionalProperties": true
        },
        "execution": {
            "type": "object",
            "description": "Execution configuration for parallel execution and advanced settings",
            "properties": {
                "parallel": {
                    "type": "object",
                    "description": "Parallel execution configuration",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "description": "Enable parallel test execution",
                            "default": false
                        },
                        "threads": {
                            "type": "integer",
                            "description": "Number of parallel threads (default: CPU cores)",
                            "minimum": 1
                        },
                        "timeout": {
                            "type": "integer",
                            "description": "Timeout per test in milliseconds",
                            "minimum": 0
                        },
                        "failFast": {
                            "type": "boolean",
                            "description": "Stop execution on first failure",
                            "default": false
                        }
                    }
                }
            }
        },
        "tests": {
            "type": "array",
            "description": "List of test steps",
            "items": {
                "type": "object",
                "properties": {
                    "id": {
                        "type": "string",
                        "description": "Unique test identifier (for dependency tracking)"
                    },
                    "name": {
                        "type": "string",
                        "description": "Name of the test step"
                    },
                    "type": {
                        "type": "string",
                        "description": "Step type",
                        "enum": [
                            "REST",
                            "GRPC",
                            "FS",
                            "BASH",
                            "SET",
                            "TRANSFORM",
                            "RESOLVE_PATH",
                            "ASSERT",
                            "WAIT",
                            "LOOP",
                            "IF",
                            "MOCK"
                        ]
                    },
                    "dependsOn": {
                        "type": "array",
                        "description": "List of test IDs this test depends on (for parallel execution)",
                        "items": {
                            "type": "string"
                        }
                    },
                    "continueOnError": {
                        "type": "boolean",
                        "description": "Continue test execution even if this step fails",
                        "default": false
                    },
                    "maxRetries": {
                        "type": "integer",
                        "description": "Maximum number of retry attempts on failure",
                        "minimum": 0
                    },
                    "retryInterval": {
                        "type": "integer",
                        "description": "Wait time between retries in milliseconds",
                        "minimum": 0
                    },
                    "rest": {
                        "type": "object",
                        "description": "REST API test configuration",
                        "properties": {
                            "url": {
                                "type": "string",
                                "description": "Target URL (supports variable substitution)"
                            },
                            "method": {
                                "type": "string",
                                "description": "HTTP method",
                                "enum": [
                                    "GET",
                                    "POST",
                                    "PUT",
                                    "DELETE",
                                    "PATCH",
                                    "HEAD",
                                    "OPTIONS"
                                ]
                            },
                            "headers": {
                                "type": "object",
                                "description": "HTTP headers",
                                "additionalProperties": {
                                    "type": "string"
                                }
                            },
                            "queryParams": {
                                "type": "object",
                                "description": "URL query parameters",
                                "additionalProperties": {
                                    "type": "string"
                                }
                            },
                            "body": {
                                "description": "Request body (JSON object, array, or string)",
                                "oneOf": [
                                    {
                                        "type": "object"
                                    },
                                    {
                                        "type": "array"
                                    },
                                    {
                                        "type": "string"
                                    }
                                ]
                            },
                            "multipart": {
                                "type": "object",
                                "description": "Multipart/form-data for file uploads and form fields",
                                "additionalProperties": true
                            },
                            "arrayFormat": {
                                "type": "string",
                                "description": "Array format for multipart uploads",
                                "enum": [
                                    "brackets",
                                    "indexed",
                                    "same"
                                ],
                                "default": "brackets"
                            },
                            "http2": {
                                "type": "boolean",
                                "description": "Use HTTP/2",
                                "default": false
                            },
                            "timeout": {
                                "type": "integer",
                                "description": "Request timeout in milliseconds",
                                "minimum": 0
                            },
                            "cookies": {
                                "description": "Cookie management",
                                "oneOf": [
                                    {
                                        "type": "string",
                                        "enum": [
                                            "auto"
                                        ]
                                    },
                                    {
                                        "type": "object",
                                        "additionalProperties": {
                                            "type": "string"
                                        }
                                    }
                                ]
                            }
                        },
                        "required": [
                            "url",
                            "method"
                        ]
                    },
                    "grpc": {
                        "type": "object",
                        "description": "gRPC test configuration",
                        "properties": {
                            "proto": {
                                "type": "string",
                                "description": "Path to .proto file or .pb descriptor set"
                            },
                            "host": {
                                "type": "string",
                                "description": "gRPC server host:port"
                            },
                            "service": {
                                "type": "string",
                                "description": "Service name"
                            },
                            "method": {
                                "type": "string",
                                "description": "Method name to call"
                            },
                            "request": {
                                "type": "object",
                                "description": "Request message as JSON",
                                "additionalProperties": true
                            },
                            "metadata": {
                                "type": "object",
                                "description": "gRPC metadata (headers)",
                                "additionalProperties": {
                                    "type": "string"
                                }
                            },
                            "timeout": {
                                "type": "integer",
                                "description": "Call timeout in milliseconds",
                                "minimum": 0
                            }
                        },
                        "required": [
                            "proto",
                            "host",
                            "service",
                            "method"
                        ]
                    },
                    "bash": {
                        "type": "object",
                        "description": "Execute bash commands or scripts",
                        "properties": {
                            "command": {
                                "type": "string",
                                "description": "Inline bash command"
                            },
                            "script": {
                                "type": "string",
                                "description": "Path to bash script file"
                            },
                            "workingDir": {
                                "type": "string",
                                "description": "Working directory"
                            },
                            "timeout": {
                                "type": "integer",
                                "description": "Timeout in milliseconds",
                                "minimum": 0,
                                "default": 30000
                            },
                            "expectedExitCode": {
                                "type": "integer",
                                "description": "Expected exit code",
                                "default": 0
                            },
                            "ignoreExitCode": {
                                "type": "boolean",
                                "description": "Ignore non-zero exit codes",
                                "default": false
                            }
                        },
                        "oneOf": [
                            {
                                "required": [
                                    "command"
                                ]
                            },
                            {
                                "required": [
                                    "script"
                                ]
                            }
                        ]
                    },
                    "fs": {
                        "type": "object",
                        "description": "File system operations",
                        "properties": {
                            "exists": {
                                "type": "string"
                            },
                            "notExists": {
                                "type": "string"
                            },
                            "read": {
                                "type": "string"
                            },
                            "isDirectory": {
                                "type": "string"
                            },
                            "size": {
                                "type": "string"
                            },
                            "write": {
                                "type": "object",
                                "properties": {
                                    "path": {
                                        "type": "string"
                                    },
                                    "content": {
                                        "type": "string"
                                    }
                                }
                            },
                            "createDir": {
                                "type": "string"
                            },
                            "deleteDir": {
                                "type": "string"
                            }
                        }
                    },
                    "set": {
                        "type": "object",
                        "description": "Set variables",
                        "properties": {
                            "variables": {
                                "type": "object",
                                "description": "Variables to set",
                                "additionalProperties": true
                            }
                        },
                        "required": [
                            "variables"
                        ]
                    },
                    "wait": {
                        "type": "object",
                        "description": "Wait/polling configuration",
                        "properties": {
                            "duration": {
                                "type": "integer",
                                "description": "Simple wait duration in milliseconds",
                                "minimum": 0
                            },
                            "condition": {
                                "type": "object",
                                "description": "Polling condition",
                                "properties": {
                                    "variable": {
                                        "type": "string",
                                        "description": "Variable name to check"
                                    },
                                    "equals": {
                                        "description": "Expected value"
                                    },
                                    "exists": {
                                        "type": "boolean",
                                        "description": "Check if variable exists"
                                    },
                                    "expression": {
                                        "type": "string",
                                        "description": "Simple expression (e.g., 'count > 5')"
                                    },
                                    "jsonPath": {
                                        "type": "string",
                                        "description": "JSONPath query"
                                    }
                                }
                            },
                            "maxRetries": {
                                "type": "integer",
                                "description": "Maximum polling attempts",
                                "minimum": 1
                            },
                            "retryInterval": {
                                "type": "integer",
                                "description": "Wait between attempts (ms)",
                                "minimum": 0
                            },
                            "timeout": {
                                "type": "integer",
                                "description": "Total timeout (ms)",
                                "minimum": 0
                            }
                        }
                    },
                    "loop": {
                        "type": "object",
                        "description": "Loop/data-driven testing configuration",
                        "properties": {
                            "items": {
                                "type": "array",
                                "description": "Inline array of items to loop over"
                            },
                            "itemsFrom": {
                                "type": "string",
                                "description": "Variable name containing array"
                            },
                            "dataSource": {
                                "type": "object",
                                "description": "External data source (CSV/JSON)",
                                "properties": {
                                    "type": {
                                        "type": "string",
                                        "enum": [
                                            "CSV",
                                            "JSON"
                                        ]
                                    },
                                    "file": {
                                        "type": "string",
                                        "description": "Path to data file"
                                    },
                                    "path": {
                                        "type": "string",
                                        "description": "JSONPath for JSON files"
                                    },
                                    "headers": {
                                        "type": "boolean",
                                        "description": "CSV has headers"
                                    }
                                }
                            },
                            "range": {
                                "type": "object",
                                "description": "Numeric range",
                                "properties": {
                                    "start": {
                                        "type": "integer"
                                    },
                                    "end": {
                                        "type": "integer"
                                    },
                                    "step": {
                                        "type": "integer",
                                        "default": 1
                                    }
                                }
                            },
                            "variable": {
                                "type": "string",
                                "description": "Variable name for current item"
                            },
                            "indexVariable": {
                                "type": "string",
                                "description": "Variable name for current index"
                            },
                            "continueOnError": {
                                "type": "boolean",
                                "description": "Continue loop on iteration failure"
                            },
                            "steps": {
                                "type": "array",
                                "description": "Steps to execute for each iteration",
                                "items": {
                                    "$ref": "#/properties/tests/items"
                                }
                            }
                        }
                    },
                    "ifConfig": {
                        "type": "object",
                        "description": "Conditional execution (IF/ELSE/ELSEIF)",
                        "properties": {
                            "condition": {
                                "type": "string",
                                "description": "Condition expression (e.g., 'status == \"active\"', 'age > 18 AND role == \"admin\"')"
                            },
                            "then": {
                                "type": "array",
                                "description": "Steps to execute if condition is true",
                                "items": {
                                    "$ref": "#/properties/tests/items"
                                }
                            },
                            "elseIf": {
                                "type": "array",
                                "description": "Else-if branches",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "condition": {
                                            "type": "string"
                                        },
                                        "then": {
                                            "type": "array",
                                            "items": {
                                                "$ref": "#/properties/tests/items"
                                            }
                                        }
                                    }
                                }
                            },
                            "elseSteps": {
                                "type": "array",
                                "description": "Steps to execute if all conditions are false",
                                "items": {
                                    "$ref": "#/properties/tests/items"
                                }
                            }
                        }
                    },
                    "mock": {
                        "type": "object",
                        "description": "Mock server configuration (WireMock)",
                        "properties": {
                            "action": {
                                "type": "string",
                                "enum": [
                                    "start",
                                    "stop",
                                    "stub",
                                    "verify",
                                    "reset"
                                ],
                                "description": "Mock server action"
                            },
                            "port": {
                                "type": "integer",
                                "description": "Server port (default: random)",
                                "minimum": 1,
                                "maximum": 65535
                            },
                            "serverId": {
                                "type": "string",
                                "description": "Server identifier for managing multiple servers"
                            },
                            "portVariable": {
                                "type": "string",
                                "description": "Variable to store server port"
                            },
                            "baseUrlVariable": {
                                "type": "string",
                                "description": "Variable to store server base URL"
                            },
                            "autoStart": {
                                "type": "boolean",
                                "description": "Auto-start server if not running",
                                "default": true
                            },
                            "stub": {
                                "type": "object",
                                "description": "Stub configuration",
                                "properties": {
                                    "request": {
                                        "type": "object",
                                        "properties": {
                                            "method": {
                                                "type": "string",
                                                "enum": [
                                                    "GET",
                                                    "POST",
                                                    "PUT",
                                                    "DELETE",
                                                    "PATCH",
                                                    "HEAD",
                                                    "OPTIONS"
                                                ]
                                            },
                                            "url": {
                                                "type": "string"
                                            },
                                            "urlPath": {
                                                "type": "string"
                                            },
                                            "urlPathPattern": {
                                                "type": "string"
                                            },
                                            "queryParameters": {
                                                "type": "object"
                                            },
                                            "headers": {
                                                "type": "object"
                                            },
                                            "bodyPattern": {
                                                "type": "string"
                                            },
                                            "bodyJson": {
                                                "type": "string"
                                            }
                                        }
                                    },
                                    "response": {
                                        "type": "object",
                                        "properties": {
                                            "status": {
                                                "type": "integer",
                                                "minimum": 100,
                                                "maximum": 599
                                            },
                                            "body": {
                                                "type": "string"
                                            },
                                            "jsonBody": {
                                                "type": "object"
                                            },
                                            "headers": {
                                                "type": "object"
                                            },
                                            "fixedDelayMilliseconds": {
                                                "type": "integer",
                                                "minimum": 0
                                            }
                                        }
                                    },
                                    "priority": {
                                        "type": "integer"
                                    },
                                    "scenarioName": {
                                        "type": "string"
                                    },
                                    "requiredScenarioState": {
                                        "type": "string"
                                    },
                                    "newScenarioState": {
                                        "type": "string"
                                    }
                                }
                            },
                            "verify": {
                                "type": "object",
                                "description": "Request verification",
                                "properties": {
                                    "request": {
                                        "type": "object"
                                    },
                                    "count": {
                                        "type": "integer",
                                        "minimum": 0
                                    },
                                    "countExpression": {
                                        "type": "string",
                                        "enum": [
                                            "exactly",
                                            "atLeast",
                                            "atMost"
                                        ]
                                    }
                                }
                            }
                        },
                        "required": [
                            "action"
                        ]
                    },
                    "transform": {
                        "type": "object",
                        "description": "Transform data",
                        "properties": {
                            "source": {
                                "type": "string"
                            },
                            "target": {
                                "type": "string"
                            },
                            "jsonPath": {
                                "type": "string"
                            }
                        }
                    },
                    "resolvePath": {
                        "type": "object",
                        "description": "Resolve file path",
                        "properties": {
                            "path": {
                                "type": "string"
                            },
                            "target": {
                                "type": "string"
                            }
                        }
                    },
                    "extract": {
                        "type": "object",
                        "description": "Extract variables using JSONPath",
                        "additionalProperties": {
                            "type": "string"
                        }
                    },
                    "expect": {
                        "type": "object",
                        "description": "Assertions",
                        "properties": {
                            "status": {
                                "type": "integer",
                                "description": "Expected status code"
                            },
                            "json": {
                                "type": "object",
                                "description": "Exact JSON values"
                            },
                            "jsonContains": {
                                "type": "object",
                                "description": "JSON contains fields"
                            },
                            "jsonNotContains": {
                                "type": "object",
                                "description": "JSON does not contain fields"
                            },
                            "jsonPath": {
                                "type": "object",
                                "description": "Advanced JSONPath assertions",
                                "additionalProperties": {
                                    "type": "object",
                                    "properties": {
                                        "exists": {
                                            "type": "boolean"
                                        },
                                        "isEmpty": {
                                            "type": "boolean"
                                        },
                                        "isNull": {
                                            "type": "boolean"
                                        },
                                        "notNull": {
                                            "type": "boolean"
                                        },
                                        "count": {
                                            "type": "integer"
                                        },
                                        "minCount": {
                                            "type": "integer"
                                        },
                                        "maxCount": {
                                            "type": "integer"
                                        },
                                        "equals": {},
                                        "notEquals": {},
                                        "contains": {},
                                        "notContains": {},
                                        "greaterThan": {},
                                        "greaterThanOrEqual": {},
                                        "lessThan": {},
                                        "lessThanOrEqual": {},
                                        "between": {
                                            "type": "object",
                                            "properties": {
                                                "min": {},
                                                "max": {}
                                            }
                                        },
                                        "matches": {
                                            "type": "string",
                                            "description": "Regex pattern"
                                        },
                                        "startsWith": {
                                            "type": "string"
                                        },
                                        "endsWith": {
                                            "type": "string"
                                        },
                                        "minLength": {
                                            "type": "integer"
                                        },
                                        "maxLength": {
                                            "type": "integer"
                                        },
                                        "type": {
                                            "type": "string",
                                            "enum": [
                                                "string",
                                                "integer",
                                                "number",
                                                "boolean",
                                                "array",
                                                "object",
                                                "null"
                                            ]
                                        },
                                        "arrayNotEmpty": {
                                            "type": "boolean"
                                        },
                                        "arraySize": {
                                            "type": "integer"
                                        },
                                        "arrayMinSize": {
                                            "type": "integer"
                                        },
                                        "arrayMaxSize": {
                                            "type": "integer"
                                        },
                                        "arrayContains": {},
                                        "arrayAll": {
                                            "type": "object",
                                            "properties": {
                                                "operator": {
                                                    "type": "string"
                                                },
                                                "value": {}
                                            }
                                        },
                                        "allOf": {
                                            "type": "array",
                                            "description": "All conditions must pass (AND)",
                                            "items": {
                                                "$ref": "#/properties/tests/items/properties/expect/properties/jsonPath/additionalProperties"
                                            }
                                        },
                                        "anyOf": {
                                            "type": "array",
                                            "description": "At least one condition must pass (OR)",
                                            "items": {
                                                "$ref": "#/properties/tests/items/properties/expect/properties/jsonPath/additionalProperties"
                                            }
                                        }
                                    }
                                }
                            },
                            "performance": {
                                "type": "object",
                                "description": "Performance expectations",
                                "properties": {
                                    "maxDuration": {
                                        "type": "integer",
                                        "description": "Max response time (ms)"
                                    },
                                    "minDuration": {
                                        "type": "integer",
                                        "description": "Min response time (ms)"
                                    }
                                }
                            },
                            "jsonSchema": {
                                "type": "string",
                                "description": "Path to JSON Schema file"
                            },
                            "dateFormats": {
                                "type": "object",
                                "description": "Date format validations",
                                "additionalProperties": {
                                    "oneOf": [
                                        {
                                            "type": "string"
                                        },
                                        {
                                            "type": "object",
                                            "properties": {
                                                "pattern": {
                                                    "type": "string"
                                                },
                                                "locale": {
                                                    "type": "string"
                                                },
                                                "min": {
                                                    "type": "string"
                                                },
                                                "max": {
                                                    "type": "string"
                                                }
                                            }
                                        }
                                    ]
                                }
                            },
                            "headers": {
                                "type": "array",
                                "description": "Header assertions",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "name": {
                                            "type": "string"
                                        },
                                        "equals": {
                                            "type": "string"
                                        },
                                        "contains": {
                                            "type": "string"
                                        },
                                        "notContains": {
                                            "type": "string"
                                        },
                                        "matches": {
                                            "type": "string"
                                        },
                                        "startsWith": {
                                            "type": "string"
                                        },
                                        "endsWith": {
                                            "type": "string"
                                        },
                                        "exists": {
                                            "type": "boolean"
                                        },
                                        "notExists": {
                                            "type": "boolean"
                                        },
                                        "greaterThan": {
                                            "type": "integer"
                                        },
                                        "lessThan": {
                                            "type": "integer"
                                        }
                                    },
                                    "required": [
                                        "name"
                                    ]
                                }
                            },
                            "fsExists": {
                                "type": "string"
                            },
                            "fsSize": {
                                "type": "string"
                            },
                            "equals": {
                                "type": "object",
                                "description": "Variable equality checks"
                            },
                            "body": {
                                "type": "object",
                                "description": "Body assertions (contains jsonPath)",
                                "properties": {
                                    "jsonPath": {
                                        "$ref": "#/properties/tests/items/properties/expect/properties/jsonPath"
                                    }
                                }
                            }
                        }
                    }
                },
                "required": [
                    "name"
                ]
            }
        }
    },
    "required": [
        "tests"
    ]
}